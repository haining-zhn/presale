<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>{$editlist["Shangji_companyname"]}商机反馈</title>
<link href="__PUBLIC__/admin/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" SRC="__PUBLIC__/admin/js/inputbig.js"></script>
<link href="__PUBLIC__/guanli/css/pagecss.css" rel="stylesheet" type="text/css" /><!--分页-->
<!--提示确认动画样式-->
<script src="__PUBLIC__/windows/js/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/windows/js/showLoading.js" type="text/javascript" charset="utf-8"></script>
<script language="javascript">
	function custom_close(){
		if(confirm("您确定要关闭本页吗？")){
			window.opener=null;
			window.open('','_self');
			window.close();
		}
		else{
		}
	}
</script> 
	<style>
		#buttonadd{
			min-width: 55px;
			font-size: 13px;
			margin-right: 20px;
			float:center;
			background-color: #3333CC;
			color: #fff;
			border: 0.5;
			padding: 3px;
			border-radius:5px;	
		}
		#buttonadd:hover { background-color: #0000CD; }
		#buttonreset:hover { background-color: #3CB371; }
		#buttonreset{
			min-width: 55px;
			font-size: 13px;
			margin-right: 20px;
			float:center;
			background-color: green;
			color: #fff;
			border: 0.5;
			padding: 3px;
			border-radius:5px;	
		}
	</style>
<script>
	lastobj=null;
	function current(obj)
	{
	if(lastobj!=null)
	{
	lastobj.style.background="";
	lastobj.style.color="";
	}
	obj.style.background="#DDDDDD";
	obj.style.color="black";
	lastobj=obj;
	}
</script>
</head>
<body>
<table width="100%" height="100%" border="0" cellspacing="0" cellpadding="3">
  <tr>
    <td style="height:25px; background-color:#f3f3f3; font-weight:bold" valign="top">
    &nbsp;&nbsp;&nbsp;&nbsp;当前位置：
	<img src="__PUBLIC__/admin/images/arrow.gif" align="absmiddle">&nbsp;&nbsp;客户管理&nbsp;&nbsp;
    <img src="__PUBLIC__/admin/images/arrow.gif" align="absmiddle">&nbsp;&nbsp;商机管理 &nbsp;&nbsp;
	<img src="__PUBLIC__/admin/images/arrow.gif" align="absmiddle">&nbsp;&nbsp;商机反馈 &nbsp;&nbsp;(商机ID:{$editlist["Shangji_id"]})
</tr>
  <tr>
    <td style="height:34px; background-image:url(__PUBLIC__/admin/images/main_header.gif); border-bottom:1px solid #cfd8e0; padding:0px">
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td width="20" height="34"><img src="__PUBLIC__/admin/images/main_headerL.gif" width="20" height="34"></td> 
          <td style="color:#90c8e8;"><img src="__PUBLIC__/admin/images/icon_card.gif" width="16" height="16" align="absmiddle">&nbsp;&nbsp;<strong>客户名称：{$editlist["Shangji_companyname"]}</strong>
		  
		  </td>
  
		<td align="right" class="white" style="padding-right:20px">
			<!-- <a href="javascript:history.go(-1);" class="barBtn"><img src="__PUBLIC__/admin/images/btn_left.gif" align="absmiddle"> 后退</a>  -->
			<a href="#" class="barBtn" onclick="location.reload();"><img src="__PUBLIC__/admin/images/btn_refresh.gif" align="absmiddle"> 刷新</a>
			<input id="btnClose" type="button" style="background-color:#3333CC;border:1;color:white;border-radius:5px;margin-left:5px;" value="关闭" onClick="custom_close()" />
		</td>
        </tr>
      </table>
	</td>
  </tr>
  <tr>
    <td height="100%"  valign="top">
	<p style="font-size:12px;line-height:20px;">
		&nbsp;<strong>联系人：</strong>{$editlist["Shangji_custname"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;【<strong>电话：</strong>{$editlist["Shangji_custphone"]}】
		&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
		&nbsp;<strong>行业：</strong>{$editlist["Shangji_custhangye"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<strong>客户级别：</strong>{$editlist["Shangji_level"]}&nbsp;&nbsp;|&nbsp;&nbsp;<strong>商机过期时间：</strong> <strong style="font-size:14px;color:red;">{$editlist["Shangji_datetime"]}</strong>（过期会被标记为：已过期。）
		<br />
		&nbsp;<strong>客户公司地址：</strong>{$editlist["Shangji_companylocal"]}<br />
		&nbsp;<strong>项目名称：</strong>{$editlist["Shangji_projectname"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<strong>项目预算：</strong>{$editlist["Shangji_projectyusuan"]}&nbsp;万元
		&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
		&nbsp;<strong>预计可参与金额：</strong>{$editlist["Shangji_projectcanyu"]}&nbsp;万元<br />
		&nbsp;<strong>涉及的产品：</strong>{$editlist['Shangji_product']}&nbsp;&nbsp;|&nbsp;&nbsp;<strong>商机来源：</strong>{$editlist["Shangji_laiyuan"]}<br />
		&nbsp;<strong>预计招标时间：</strong>{$editlist["Shangji_projectzhaobiao"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<strong>项目开始时间：</strong>{$editlist["Shangji_startdate"]}<br />
		&nbsp;<strong>责任人（主任）：</strong>{$editlist["Shangji_custmanageradmin"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<strong>客户经理：</strong>{$editlist["Shangji_custmanager"]}
		&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
		&nbsp;<strong>区县：</strong>{$editlist["Shangji_localqx"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<strong>网格：</strong>{$editlist["Shangji_localwg"]}&nbsp;&nbsp;(&nbsp;网格ID:{$editlist["Shangji_localwgid"]}&nbsp;)<br />
		&nbsp;<strong>创建人：</strong>{$editlist["Shangji_person"]}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;<strong>录入时间：</strong>{$editlist["Shangji_date"]}
		&nbsp;|&nbsp;&nbsp;<strong style="color:red">
		商机状态：</strong>{$editlist["Shangji_zhuangtai"]}
		<if condition="$editlist['Shangji_zhuangtai'] eq '已签约'"> 
			（签约时间：<strong style="font-size:14px;color:red;">{$editlist["Shangji_qianyuedate"]}</strong>&nbsp;支付方式：<strong style="font-size:14px;color:red;">{$editlist["Shangji_qianyueway"]}</strong>&nbsp;签约金额：<strong style="font-size:14px;color:red;">{$editlist["Shangji_qianyuejine"]}</strong>万）
		<else />
		</if>
		<br />
		&nbsp;<strong>最新跟踪情况：</strong>（最新跟踪时间：{$editlist["Shangji_lastchulidate"]}） &nbsp;<strong>商机对接人(管理员) ：</strong>{$editlist["Shangji_adminperson"]}
		<textarea style="width:90%;height:30px;resize: none;font-size:12px;background-color:#C0C0C0">{$editlist['Shangji_lastbeizhu']}</textarea>
		<br />
		&nbsp;<strong>备注：</strong>
		<textarea style="width:100%;height:40px;resize: none;font-size:12px;background-color:#C0C0C0">{$editlist['Shangji_beizhu']}</textarea>
	</p>
    <div style="overflow:auto;height:100%; width:100%">
	<table width="100%"  border="0" cellpadding="3" cellspacing="1" class="table1">
		  <TR>
		  <th align="center" width="40">序号</th>
		  <th align="center">跟踪详情(按时间降序！)</th>
		  <th align="center" width="80">跟踪人</th>
		  <th align="center" width="90">跟踪时间</th>
		  <th align="center" width="40">操作</th>
          </TR>
	<volist name="list" id="vo" key="k" empty="当前无反馈内容">
		 <tr onclick=current(this) id="tr_{$vo.Shangjifankui_id}">
          <TD align="center">{$k}</TD>
		  <TD align="left" title="{$vo.Shangjifankui_content}">
			<textarea style="font-size:12px;resize: none;height:22px;border: 1; width:100%;" >{$vo.Shangjifankui_content}</textarea>
		  </TD>
		  <TD align="center">{$vo.Shangjifankui_person}</TD>
		  <TD align="center" >{$vo.Shangjifankui_date}</TD>
		  <TD align="center" style="color:blue;">
		  
		<if condition="$editlist['Shangji_zhuangtai'] eq '已签约' or $editlist['Shangji_zhuangtai'] eq '商机丢失'">   
			<a href="javascript:void(0)" onclick="errorjieguo('商机生命周期已结束，无法删除反馈！')" style="color:#909090;">
		<else />
			<if condition="$vo.Shangjifankui_person eq  $loginusers['Person_name'] or $loginusers['Person_id'] eq 110110 "> 
				<a style="color:red;" href="javascript:void(0)" onclick="del_shangjifankui({$vo.Shangjifankui_id})">
			<else />
				<a href="javascript:void(0)" onclick="errorjieguo('只能删除自己跟踪的！')" style="color:#909090;">
			</if>		
		</if>
				删除
			</a>
		  </TD>
         </TR>
    </volist>
	  </table>
	<div class="yahoo2">
		{$Page}
	</div>
<br />
	  <div style="heigt-line:30px;">
		<form class="layui-form" name="myForm" id="fm"  enctype="multipart/form-data">
			<SPAN>
				&nbsp;&nbsp;&nbsp;反馈跟踪情况：
				<if condition="$editlist['Shangji_zhuangtai'] eq '已签约' or $editlist['Shangji_zhuangtai'] eq '商机丢失'"> 
					<textarea type="text" disabled="disabled" name="Shangjifankui_content" required="true" style="width:300px;height:22px;font-size:13px;" placeholder="商机生命周期已结束，无需反馈。"></textarea>
				<else />
					<textarea type="text"  name="Shangjifankui_content" required="true" style="width:300px;height:22px;font-size:13px;" placeholder="该内容会同步到商机表'最新跟踪详情'只保留最新一条内容。200字符以内。"></textarea>
				</if>
					<script type="text/javascript">
						$(document).ready(function() {
							$("textarea[type='text']").focus(function(){
							$(this).animate({"width":"300px","height":"50px"})
							}).blur(function(){
								$(this).animate({"width":"300px","height":"22px"})
							});
						});
					</script><span style="color:red;">*</span>
					&nbsp;&nbsp;&nbsp;&nbsp;
			当前商机状态：
				<select name="zhuangtai" required="true">
				  <option value="{$editlist["Shangji_zhuangtai"]}">-当前:{$editlist["Shangji_zhuangtai"]}-</option>
				<if condition="$editlist['Shangji_zhuangtai'] eq '已签约' or $editlist['Shangji_zhuangtai'] eq '商机丢失'"> 
				
				<else />
				  <option value="初步洽谈">-初步洽谈-</option>
				  <option value="已报价">-已报价-</option>
				  <option value="跟进中">-跟进中-</option>
				  <option value="已签约">-已签约-</option>
                  <option value="商机丢失">-商机丢失-</option>
				</if>
				</select>	<span style="color:red;">*</span>
				 &nbsp;商机丢失、已签约不可以改商机状态。
				<!-- <input type="file"  name="baojiadan" title="限制1个<5M (pdf、doc、execl)" required="true" style="font-size:12px;width:120px;" /> -->
				<br /><br />
				<if condition="$editlist['Shangji_zhuangtai'] eq '已签约' or $editlist['Shangji_zhuangtai'] eq '商机丢失'"> 	
					&nbsp;&nbsp;&nbsp;&nbsp;
				<else />
					&nbsp;&nbsp;&nbsp;签约时间：
					<input  type="date" required="true" style="height:25px;width:120px;" class="sang_Calender" placeholder="请选择时间" name="qianyuedate" />
					&nbsp;&nbsp;&nbsp;&nbsp;
					签约计费方式：
					<select name="qanyueway">
						<option value="">-请选择-</option>
					  <option value="一次性支付">-一次性支付-</option>
					  <option value="按月支付">-按月支付-</option>
					  <option value="按年支付">-按年支付-</option>
					</select>&nbsp;&nbsp;&nbsp;&nbsp;
					签约金额：<input type="text" name="qianyuejine"  placeholder="输入数字"  id="shuliang" style="width:60px;">：万元&nbsp;(合同金额 或 云业务按月则为报价单金额)&nbsp;
					<script>
						var oInp = document.getElementById('shuliang');
						oInp.onblur=function(){
							if(isNaN(Number(oInp.value))){  //当输入不是数字的时候，Number后返回的值是NaN;然后用isNaN判断。
								alert('请填正确填写金额！');
								return false;
							 }
						 }
					</script>
				</if>
			</SPAN>
			<p style="margin:5px 40%;">
			<br />
				<input type="button" name="anniu" class="layui-btn" id="buttonadd" lay-submit value="反馈" style="margin-right:20px;"  onclick="submitFrom()" />
				<input type="button" class="layui-btn" id="buttonreset" value="重置" onclick="resetFrom()"/>
				<input type="hidden" name="Shangji_id" value="{$editlist['Shangji_id']}">
			</p>
		</form> 
	  </div>
  </td>
  </tr>
</table>
<script type="text/javascript">
    //提交
        document.getElementById('buttonadd').onclick = function () { 
			//验证数据为空
			if(!myForm.Shangjifankui_content.value){
				myForm.Shangjifankui_content.focus();
				return ;
			}
			if(!myForm.zhuangtai.value){
				myForm.zhuangtai.focus();
				return ;
			}
			//找到表单DOM对象
            var fm = document.getElementById('fm');
            // 创建FormData对象并传递表单
            var fd = new FormData(fm);
			var url='__URL__/add_shangjifankui_action';
            var xhr = new XMLHttpRequest();
            //接口fd：收到提交的数据后会返回收到的数据
            xhr.open('POST',url, '/fd');
            xhr.send(fd);
			xhr.onreadystatechange=function(){
				if(xhr.readyState==4&&xhr.status==200){
					if(xhr.responseText!=1){
						return errorjieguo(xhr.responseText);
					}else{ 
						return successfankui();	
					}
				};

			};
        }
    //重置
    function resetFrom()
    {
        //重置表单
        document.getElementsByName("myForm")[0].reset();
    }

	function successfankui(){
		showLoading({
			title: "反馈成功！", //提示文字
			icon: 'success', // 图标，有效值 "success", "loading", "none"
			image: '', // 自定义图标的本地路径，image 的优先级高于 icon
			duration: 2000, //提示的延迟时间，单位毫秒，默认：1500
			mask: true, // 是否显示透明蒙层，防止触摸穿透，默认：false
			success: function(res) { //接口调用成功的回调函数
				console.log(JSON.stringify(res))
			},
			
		});
		parent.location.reload();   //刷新当前页面
	}
	function loading(s){
		showLoading({
			title: s, //提示文字
			icon: 'loading', // 图标，有效值 "success", "loading", "none"
			image: '', // 自定义图标的本地路径，image 的优先级高于 icon
			duration: 50000, //提示的延迟时间，单位毫秒，默认：1500
			mask: true, // 是否显示透明蒙层，防止触摸穿透，默认：false
			success: function(res) { //接口调用成功的回调函数
				console.log(JSON.stringify(res))
			},
		
		});
		setTimeout(function() {
			hideLoading()
		}, 2000)
	}
	function del_shangjifankui(catid){
		showModal({ 
			title: "温馨提示",  //提示的标题
			content: "确认要删除吗？",  //提示的内容
			showCancel: true,  //是否显示取消按钮，默认为 true
			cancelText: '取消',  //取消按钮的文字，默认为"取消"，最多 4 个字符
			cancelColor: "#fff",  //取消按钮的文字颜色，默认为"#000000"
			cancelBgColor: '#4c4c4c',  //取消按钮的背景颜色 
			confirmText: '确定',
			confirmColor: '#fff',
			confirmBgColor: '#55aaff',
			success: function(res) {
				if (res.confirm) {
					var xhr=new XMLHttpRequest();
					var url='__URL__/del_shangjifankui?id='+catid;
					xhr.open('get',url);
					xhr.send(null);
					xhr.onreadystatechange=function(){
						if(xhr.readyState==4&&xhr.status==200){
							if(xhr.responseText==1){
								document.getElementById('tr_'+catid).remove();
								return successjieguo();
							}else if(xhr.responseText==0){
								return errorjieguo("删除失败，该记录可能不存在！");
							}else{
								return errorjieguo("其他错误，请联系管理员！");
							}
						};
					}
						
				} else {
					console.log('取消');
				}
			}
		});
	}
	function errorjieguo(a){
		showModal({ 
			title: "温馨提示",  //提示的标题
			content: a,  //提示的内容
			titleColor:'red',
			showCancel: false,  //是否显示取消按钮，默认为 true
			cancelText: 'no',  //取消按钮的文字，默认为"取消"，最多 4 个字符
			cancelColor: "#fff",  //取消按钮的文字颜色，默认为"#000000"
			cancelBgColor: '#4c4c4c',  //取消按钮的背景颜色 
			confirmText: '已知晓',
			confirmColor: '#fff',
			confirmBgColor: '#55aaff',
			success: function(res) {
				if (res.confirm) {
					console.log('yes');
				} else {
					console.log('no');
				}
			}
		});
	}
	function successjieguo(){
		showLoading({
			title: "删除成功！", //提示文字
			icon: 'success', // 图标，有效值 "success", "loading", "none"
			image: '', // 自定义图标的本地路径，image 的优先级高于 icon
			duration: 1000, //提示的延迟时间，单位毫秒，默认：1500
			mask: true, // 是否显示透明蒙层，防止触摸穿透，默认：false
			success: function(res) { //接口调用成功的回调函数
				console.log(JSON.stringify(res))
			},
		});
		parent.location.reload();   //刷新当前页面
	}
</script>
</body>
</html>